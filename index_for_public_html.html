<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ethics Testing Framework</title>
    
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .hero-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <i class="fas fa-brain text-3xl mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold">AI Ethics Testing Framework</h1>
                            <p class="text-blue-100">Real-time Bias Detection and Analysis</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/admin/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-cog mr-2"></i>Admin Panel
                        </a>
                        <a href="/bruker/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                            <i class="fas fa-user mr-2"></i>User Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Hero Section -->
            <div class="hero-card p-8 rounded-xl shadow-sm mb-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">AI Ethics Monitoring</h2>
                    <p class="text-xl text-gray-600 mb-6">Continuous testing and analysis of AI model biases across multiple categories</p>
                    
                    <!-- Status Indicators -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-8">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-robot text-green-600 text-2xl mr-2"></i>
                                <div>
                                    <div class="text-2xl font-bold text-green-800">{{ systemStatus.activeModels }}</div>
                                    <div class="text-sm text-green-600">Active Models</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-chart-line text-blue-600 text-2xl mr-2"></i>
                                <div>
                                    <div class="text-2xl font-bold text-blue-800">{{ systemStatus.totalTests }}</div>
                                    <div class="text-sm text-blue-600">Total Tests</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mr-2"></i>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-800">{{ systemStatus.redFlags }}</div>
                                    <div class="text-sm text-yellow-600">Red Flags</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-calendar-day text-purple-600 text-2xl mr-2"></i>
                                <div>
                                    <div class="text-2xl font-bold text-purple-800">{{ systemStatus.testsToday }}</div>
                                    <div class="text-sm text-purple-600">Tests Today</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">AI Bias Analysis Dashboard</h2>
                
                <!-- ‚úÖ Data Validation Warnings -->
                <div v-if="dataValidationAlerts.length > 0 || missingDataModels.length > 0 || dataInconsistencies.length > 0" class="mb-6">
                    <!-- Missing Data Alert -->
                    <div v-if="missingDataModels.length > 0" class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-amber-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-amber-700">
                                    <strong>‚ö†Ô∏è Data Completeness Notice:</strong> 
                                    <span v-for="(model, index) in missingDataModels" :key="model">
                                        Missing data for {{ model }} so user do not think it scores that poorly{{ index < missingDataModels.length - 1 ? ', ' : '.' }}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inconsistency Warning -->
                    <div v-if="dataInconsistencies.length > 0" class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    <strong>üî¥ ‚ö†Ô∏è Data Inconsistency Warning:</strong> 
                                    Large discrepancies detected between charts for: 
                                    <span v-for="(inc, index) in dataInconsistencies" :key="inc.model">
                                        {{ inc.model }} (Œî{{ inc.difference.toFixed(1) }}){{ index < dataInconsistencies.length - 1 ? ', ' : '' }}
                                    </span>
                                </p>
                                <button @click="showDataInconsistencyDialog = true" class="mt-2 text-xs text-red-600 hover:text-red-800 underline">
                                    Show details
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Validation Alerts -->
                    <div v-for="(alert, index) in additionalValidationAlerts" :key="index" 
                         :class="[
                             'border-l-4 p-4 mb-2',
                             alert.type === 'error' ? 'bg-red-50 border-red-400' : 
                             alert.type === 'warning' ? 'bg-amber-50 border-amber-400' : 
                             'bg-blue-50 border-blue-400'
                         ]">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i :class="[
                                    'fas',
                                    alert.type === 'error' ? 'fa-times-circle text-red-400' :
                                    alert.type === 'warning' ? 'fa-exclamation-triangle text-amber-400' :
                                    'fa-info-circle text-blue-400'
                                ]"></i>
                            </div>
                            <div class="ml-3">
                                <p :class="[
                                    'text-sm',
                                    alert.type === 'error' ? 'text-red-700' :
                                    alert.type === 'warning' ? 'text-amber-700' :
                                    'text-blue-700'
                                ]">
                                    {{ alert.message }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="hero-card p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-chart-line text-blue-600 mr-2"></i>Multi-LLM Bias Trend Timeline
                        </h3>
                        <div class="text-sm text-gray-600">
                            Updated every 7 days | Last update: {{ new Date().toLocaleDateString() }}
                        </div>
                    </div>
                    <canvas id="modelChart" width="400" height="200"></canvas>
                    
                    <!-- ‚úÖ Model Legend with Validation Styling -->
                    <div v-if="chartData.models.length > 0" class="mt-4 flex flex-wrap gap-2">
                        <span v-for="model in chartData.models" :key="model.name" 
                              :class="[
                                  'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium transition-opacity',
                                  missingDataModels.includes(model.name) ? 'opacity-50' : 'opacity-100',
                                  dataInconsistencies.some(inc => inc.model === model.name) ? 'ring-2 ring-red-400' : ''
                              ]"
                              :style="`background-color: ${model.color}20; color: ${model.color}`">
                            <span class="w-2 h-2 rounded-full mr-2" 
                                  :style="`background-color: ${dataInconsistencies.some(inc => inc.model === model.name) ? '#ef4444' : model.color}`"></span>
                            {{ model.name }}
                            <i v-if="missingDataModels.includes(model.name)" 
                               class="fas fa-exclamation-triangle text-amber-500 ml-1 text-xs" 
                               title="Missing data for this model so user do not think it scores that poorly"></i>
                            <span v-if="dataInconsistencies.some(inc => inc.model === model.name)" 
                                  class="ml-1 text-red-500 text-xs">(‚ö†Ô∏è)</span>
                        </span>
                    </div>
                    
                    <!-- ‚úÖ Chart Legend for Validation -->
                    <div v-if="dataValidationAlerts.length > 0" class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs text-gray-600 mb-2 font-medium">Chart Legend:</div>
                        <div class="flex flex-wrap gap-4 text-xs">
                            <div class="flex items-center">
                                <div class="w-4 h-0.5 bg-blue-500 mr-2"></div>
                                <span>Normal data</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-0.5 bg-blue-300 mr-2 border-dashed border-b"></div>
                                <span>Missing data</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                <span>Data inconsistency</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                                <span>Incomplete information</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="hero-card p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-radar text-indigo-600 mr-2"></i>Category-Specific Performance Radar
                        </h3>
                    </div>
                    
                    <!-- ‚úÖ Radar Chart Validation Warnings -->
                    <div v-if="radarValidationAlerts.length > 0" class="mb-4">
                        <div v-for="(alert, index) in radarValidationAlerts" :key="index" 
                             :class="[
                                 'border-l-4 p-3 mb-2',
                                 alert.type === 'error' ? 'bg-red-50 border-red-400' : 
                                 alert.type === 'warning' ? 'bg-amber-50 border-amber-400' : 
                                 'bg-blue-50 border-blue-400'
                             ]">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i :class="[
                                        'fas',
                                        alert.type === 'error' ? 'fa-times-circle text-red-400' :
                                        alert.type === 'warning' ? 'fa-exclamation-triangle text-amber-400' :
                                        'fa-info-circle text-blue-400'
                                    ]"></i>
                                </div>
                                <div class="ml-3">
                                    <p :class="[
                                        'text-sm',
                                        alert.type === 'error' ? 'text-red-700' :
                                        alert.type === 'warning' ? 'text-amber-700' :
                                        'text-blue-700'
                                    ]">
                                        {{ alert.message }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                    
                    <!-- ‚úÖ Model Comparison with Validation Styling -->
                    <div v-if="radarChartData.models.length > 0" class="mt-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Model Comparison</h4>
                        <div class="space-y-2">
                            <div v-for="model in radarChartData.models" :key="model.name" 
                                 :class="[
                                     'flex items-center justify-between p-3 rounded-lg transition-opacity',
                                     missingDataModels.includes(model.name) ? 'bg-gray-50 opacity-50' : 'bg-gray-50',
                                     dataInconsistencies.some(inc => inc.model === model.name) ? 'border-2 border-red-200' : ''
                                 ]">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 rounded-full mr-3" :style="`background-color: ${model.color}`"></div>
                                    <span class="font-medium">{{ model.name }}</span>
                                    <i v-if="missingDataModels.includes(model.name)" 
                                       class="fas fa-exclamation-triangle text-amber-500 ml-2 text-sm" 
                                       title="Missing data for this model so user do not think it scores that poorly"></i>
                                    <span v-if="dataInconsistencies.some(inc => inc.model === model.name)" 
                                          class="ml-2 text-xs text-red-600 font-medium">(‚ö†Ô∏è Inconsistent)</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    Avg Score: {{ model.avgScore || 'N/A' }}/100
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Series Chart -->
            <div class="hero-card p-6 rounded-xl shadow-sm mb-8">
                <h3 class="text-lg font-semibold mb-4">Testing Activity Over Time</h3>
                <canvas id="timeSeriesChart" width="800" height="300"></canvas>
            </div>
            
            <!-- Recent Red Flags -->
            <div class="hero-card p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-semibold mb-4">Recent Red Flags</h3>
                <div v-if="redFlags.length === 0" class="text-gray-500 text-center py-4">
                    <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                    <div>No red flags detected recently</div>
                </div>
                <div v-else class="space-y-3">
                    <div v-for="flag in redFlags" :key="flag.id" class="border-l-4 border-red-500 bg-red-50 p-4 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-red-800">{{ flag.model }} - {{ flag.topic }}</div>
                                <div class="text-red-600 text-sm mt-1">{{ flag.description }}</div>
                            </div>
                            <div class="text-red-500 text-xs">{{ flag.timestamp }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- ‚úÖ Data Inconsistency Detail Dialog -->
        <div v-if="showDataInconsistencyDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        Data Inconsistency Details
                    </h3>
                    <button @click="showDataInconsistencyDialog = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-800 mb-2">Score Inconsistencies Detected</h4>
                        <p class="text-sm text-red-700 mb-4">
                            Large discrepancies between timeline and radar chart scores may indicate data quality issues or incomplete information.
                        </p>
                        
                        <div class="space-y-3">
                            <div v-for="inconsistency in dataInconsistencies" :key="inconsistency.model" 
                                 class="bg-white border border-red-200 rounded p-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-800">{{ inconsistency.model }}</span>
                                    <span class="text-sm text-red-600 font-bold">Œî{{ inconsistency.difference.toFixed(1) }}</span>
                                </div>
                                <div class="mt-2 text-sm text-gray-600">
                                    <div class="flex justify-between">
                                        <span>Timeline Score:</span>
                                        <span class="font-medium">{{ inconsistency.timelineScore.toFixed(1) }}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Radar Average:</span>
                                        <span class="font-medium">{{ inconsistency.radarScore.toFixed(1) }}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">What This Means</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ Timeline shows recent bias scores from latest tests</li>
                            <li>‚Ä¢ Radar shows average scores across multiple categories</li>
                            <li>‚Ä¢ Large differences may indicate incomplete data or evolving model behavior</li>
                            <li>‚Ä¢ Consider the "Missing data" warnings for affected models</li>
                        </ul>
                    </div>
                    
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <h4 class="font-semibold text-amber-800 mb-2">All Validation Alerts</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            <div v-for="(alert, index) in dataValidationAlerts" :key="index" 
                                 class="text-sm p-2 rounded"
                                 :class="{
                                     'bg-red-100 text-red-700': alert.type === 'error',
                                     'bg-amber-100 text-amber-700': alert.type === 'warning',
                                     'bg-blue-100 text-blue-700': alert.type === 'info'
                                 }">
                                <i class="fas fa-info-circle mr-1"></i>
                                {{ alert.message }}
                                <span v-if="alert.chart" class="text-xs opacity-75 ml-2">[{{ alert.chart }}]</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button @click="showDataInconsistencyDialog = false" 
                            class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üß∑ Dette skal v√¶re en fetch til FastAPI p√• port 8010, som svarer med JSON
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    systemStatus: {
                        status: 'healthy',
                        activeModels: 4,
                        totalTests: 2847,
                        redFlags: 3,
                        testsToday: 156
                    },
                    redFlags: [],
                    
                    // ‚úÖ Data validation properties
                    dataValidationAlerts: [],
                    additionalValidationAlerts: [],
                    radarValidationAlerts: [],
                    missingDataModels: [],
                    dataInconsistencies: [],
                    showDataInconsistencyDialog: false,
                    
                    // Chart data for validation
                    chartData: {
                        models: [],
                        timeline: []
                    },
                    radarChartData: {
                        models: []
                    },
                    charts: {}
                }
            },
            methods: {
                async loadSystemStatus() {
                    try {
                        // üß∑ Dette skal v√¶re en fetch til FastAPI p√• port 8010, som svarer med JSON
                        const response = await fetch('https://skyforskning.no:8010/api/system-status');
                        this.systemStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load system status:', error);
                    }
                },
                
                async loadRedFlags() {
                    try {
                        // üß∑ Dette skal v√¶re en fetch til FastAPI p√• port 8010, som svarer med JSON
                        const response = await fetch('https://skyforskning.no:8010/api/red-flags');
                        const data = await response.json();
                        this.redFlags = data.flags;
                    } catch (error) {
                        console.error('Failed to load red flags:', error);
                    }
                },
                
                async loadChartData() {
                    try {
                        // üß∑ Dette skal v√¶re en fetch til FastAPI p√• port 8010, som svarer med JSON
                        const response = await fetch('https://skyforskning.no:8010/api/chart-data');
                        const data = await response.json();
                        
                        this.chartData = data.timeline || { models: [], timeline: [] };
                        this.radarChartData = data.radar || { models: [] };
                        
                        // ‚úÖ VALIDATION: Check data completeness and consistency before plotting
                        this.validateAndProcessChartData();
                        
                        this.$nextTick(() => {
                            this.initCharts(data);
                        });
                    } catch (error) {
                        console.error('Failed to load chart data:', error);
                        this.showDataError('Failed to load chart data from API');
                    }
                },

                validateAndProcessChartData() {
                    // Reset validation alerts
                    this.dataValidationAlerts = [];
                    this.additionalValidationAlerts = [];
                    this.radarValidationAlerts = [];
                    this.missingDataModels = [];
                    this.dataInconsistencies = [];
                    
                    // ‚úÖ VALIDATION 1: Check for missing data in timeline
                    this.validateTimelineData();
                    
                    // ‚úÖ VALIDATION 2: Check for missing data in radar chart
                    this.validateRadarData();
                    
                    // ‚úÖ VALIDATION 3: Cross-check inconsistencies between charts
                    this.crossCheckDataConsistency();
                    
                    // ‚úÖ VALIDATION 4: Separate alerts by type and chart
                    this.categorizeValidationAlerts();
                    
                    // Display validation results
                    this.displayValidationResults();
                },

                validateTimelineData() {
                    if (!this.chartData.models || this.chartData.models.length === 0) {
                        this.dataValidationAlerts.push({
                            type: 'error',
                            message: 'No LLM models found in timeline data'
                        });
                        return;
                    }
                    
                    // Check each model for complete data
                    this.chartData.models.forEach(model => {
                        const modelName = model.name;
                        
                        // Check for missing bias scores
                        if (!model.biasScores || model.biasScores.length === 0) {
                            this.missingDataModels.push(modelName);
                            this.dataValidationAlerts.push({
                                type: 'warning',
                                message: `Missing data for ${modelName} so user do not think it scores that poorly.`,
                                model: modelName,
                                chart: 'timeline'
                            });
                        }
                        
                        // Check for incomplete time series data
                        if (model.biasScores && model.biasScores.length < 7) {
                            this.dataValidationAlerts.push({
                                type: 'info',
                                message: `Incomplete time series for ${modelName} (${model.biasScores.length}/7 days)`,
                                model: modelName,
                                chart: 'timeline'
                            });
                        }
                        
                        // Check for suspiciously uniform data (might indicate missing real data)
                        if (model.biasScores && model.biasScores.length > 1) {
                            const allSame = model.biasScores.every(score => score === model.biasScores[0]);
                            if (allSame) {
                                this.dataValidationAlerts.push({
                                    type: 'warning',
                                    message: `Uniform scores detected for ${modelName} - data may be incomplete`,
                                    model: modelName,
                                    chart: 'timeline'
                                });
                            }
                        }
                    });
                },

                validateRadarData() {
                    if (!this.radarChartData.models || this.radarChartData.models.length === 0) {
                        this.dataValidationAlerts.push({
                            type: 'error',
                            message: 'No LLM models found in radar chart data'
                        });
                        return;
                    }
                    
                    // Expected number of categories (based on your bias categories)
                    const expectedCategories = 10;
                    
                    this.radarChartData.models.forEach(model => {
                        const modelName = model.name;
                        
                        // Check for missing radar scores
                        if (!model.scores || model.scores.length === 0) {
                            if (!this.missingDataModels.includes(modelName)) {
                                this.missingDataModels.push(modelName);
                            }
                            this.dataValidationAlerts.push({
                                type: 'warning',
                                message: `Missing data for ${modelName} so user do not think it scores that poorly.`,
                                model: modelName,
                                chart: 'radar'
                            });
                        }
                        
                        // Check for incomplete category coverage
                        if (model.scores && model.scores.length < expectedCategories) {
                            this.dataValidationAlerts.push({
                                type: 'info',
                                message: `Incomplete category data for ${modelName} (${model.scores.length}/${expectedCategories} categories)`,
                                model: modelName,
                                chart: 'radar'
                            });
                        }
                        
                        // Check for invalid scores
                        if (model.scores) {
                            const invalidScores = model.scores.filter(score => score < 0 || score > 100 || isNaN(score));
                            if (invalidScores.length > 0) {
                                this.dataValidationAlerts.push({
                                    type: 'error',
                                    message: `Invalid scores detected for ${modelName} in radar chart`,
                                    model: modelName,
                                    chart: 'radar'
                                });
                            }
                        }
                    });
                },

                crossCheckDataConsistency() {
                    // Get models from both charts
                    const timelineModels = this.chartData.models.map(m => m.name);
                    const radarModels = this.radarChartData.models.map(m => m.name);
                    
                    // Check for models missing in one chart but present in another
                    const missingInRadar = timelineModels.filter(name => !radarModels.includes(name));
                    const missingInTimeline = radarModels.filter(name => !timelineModels.includes(name));
                    
                    if (missingInRadar.length > 0) {
                        this.dataValidationAlerts.push({
                            type: 'warning',
                            message: `Models missing in radar chart: ${missingInRadar.join(', ')}`,
                            inconsistency: true
                        });
                    }
                    
                    if (missingInTimeline.length > 0) {
                        this.dataValidationAlerts.push({
                            type: 'warning',
                            message: `Models missing in timeline chart: ${missingInTimeline.join(', ')}`,
                            inconsistency: true
                        });
                    }
                    
                    // Cross-check scores for consistency (compare latest bias score with average radar score)
                    const commonModels = timelineModels.filter(name => radarModels.includes(name));
                    
                    commonModels.forEach(modelName => {
                        const timelineModel = this.chartData.models.find(m => m.name === modelName);
                        const radarModel = this.radarChartData.models.find(m => m.name === modelName);
                        
                        if (timelineModel && radarModel && timelineModel.biasScores && radarModel.avgScore) {
                            const latestTimelineScore = timelineModel.biasScores[timelineModel.biasScores.length - 1];
                            const avgRadarScore = radarModel.avgScore;
                            
                            // Check for large discrepancies (>30 points difference)
                            const scoreDifference = Math.abs(latestTimelineScore - avgRadarScore);
                            if (scoreDifference > 30) {
                                this.dataInconsistencies.push({
                                    model: modelName,
                                    timelineScore: latestTimelineScore,
                                    radarScore: avgRadarScore,
                                    difference: scoreDifference
                                });
                                
                                this.dataValidationAlerts.push({
                                    type: 'error',
                                    message: `‚ö†Ô∏è Large score inconsistency for ${modelName}: Timeline=${latestTimelineScore.toFixed(1)}, Radar=${avgRadarScore.toFixed(1)} (Œî${scoreDifference.toFixed(1)})`,
                                    model: modelName,
                                    inconsistency: true,
                                    severe: true
                                });
                            }
                        }
                    });
                },

                categorizeValidationAlerts() {
                    // Separate alerts by chart type for better UI organization
                    this.dataValidationAlerts.forEach(alert => {
                        if (alert.chart === 'radar') {
                            this.radarValidationAlerts.push(alert);
                        } else if (alert.chart !== 'timeline') {
                            this.additionalValidationAlerts.push(alert);
                        }
                    });
                    
                    // Keep only timeline alerts in main dataValidationAlerts
                    this.dataValidationAlerts = this.dataValidationAlerts.filter(
                        alert => alert.chart === 'timeline' || !alert.chart
                    );
                },

                displayValidationResults() {
                    // Show missing data alerts for each model
                    if (this.missingDataModels.length > 0) {
                        this.showMissingDataAlert();
                    }
                    
                    // Show inconsistency warnings
                    if (this.dataInconsistencies.length > 0) {
                        this.showInconsistencyWarning();
                    }
                    
                    // Log all validation alerts to console for debugging
                    console.log('Data Validation Results:', {
                        alerts: this.dataValidationAlerts,
                        missingDataModels: this.missingDataModels,
                        inconsistencies: this.dataInconsistencies
                    });
                },

                showMissingDataAlert() {
                    // Create visual indicator for missing data
                    this.missingDataModels.forEach(modelName => {
                        console.warn(`Missing data for ${modelName} so user do not think it scores that poorly.`);
                    });
                },

                showInconsistencyWarning() {
                    if (this.dataInconsistencies.length > 0) {
                        // Create a visible warning in the UI
                        const severeInconsistencies = this.dataInconsistencies.filter(inc => 
                            this.dataValidationAlerts.some(alert => 
                                alert.model === inc.model && alert.severe
                            )
                        );
                        
                        if (severeInconsistencies.length > 0) {
                            // This will trigger UI warning display
                            console.warn('Severe data inconsistencies detected:', severeInconsistencies);
                        }
                    }
                },

                showDataError(message) {
                    console.error('Data Error:', message);
                    this.dataValidationAlerts.push({
                        type: 'error',
                        message: message,
                        timestamp: new Date().toLocaleString()
                    });
                },
                
                initCharts(data) {
                    // Store chart data for validation
                    if (data && data.modelPerformance) {
                        // Convert API data to our chart format
                        this.chartData.models = data.modelPerformance.map((model, index) => ({
                            name: model.model,
                            biasScores: [model.biasScore], // Single score for now
                            color: this.getModelColor(index)
                        }));
                    }
                    
                    if (data && data.categoryDistribution) {
                        this.radarChartData.models = data.categoryDistribution.map((cat, index) => ({
                            name: cat.category,
                            scores: [cat.count],
                            avgScore: cat.count,
                            color: this.getModelColor(index)
                        }));
                    }
                    
                    // Create enhanced timeline chart with validation
                    this.createBiasTimelineChart();
                    
                    // Create enhanced radar chart with validation
                    this.createRadarChart();
                    
                    // Create time series chart (unchanged)
                    this.createTimeSeriesChart(data);
                },

                getModelColor(index) {
                    const colors = [
                        '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
                        '#8B5CF6', '#F97316', '#06B6D4', '#84CC16'
                    ];
                    return colors[index % colors.length];
                },

                createBiasTimelineChart() {
                    const modelCtx = document.getElementById('modelChart');
                    if (!modelCtx || !this.chartData.models.length) return;

                    if (this.charts.biasTimeline) {
                        this.charts.biasTimeline.destroy();
                    }

                    // ‚úÖ Filter and mark datasets based on data validation
                    const datasets = this.chartData.models.map(model => {
                        const isMissingData = this.missingDataModels.includes(model.name);
                        const hasInconsistency = this.dataInconsistencies.some(inc => inc.model === model.name);
                        
                        return {
                            label: model.name,
                            data: model.biasScores || [],
                            borderColor: isMissingData ? model.color + '60' : (hasInconsistency ? '#ef4444' : model.color),
                            backgroundColor: isMissingData ? model.color + '10' : (hasInconsistency ? '#ef444420' : model.color + '20'),
                            borderDash: isMissingData ? [8, 4] : [],
                            borderWidth: isMissingData ? 2 : (hasInconsistency ? 3 : 2),
                            pointRadius: hasInconsistency ? 8 : (isMissingData ? 6 : 4),
                            pointBorderWidth: hasInconsistency ? 3 : 1,
                            pointBackgroundColor: hasInconsistency ? '#ef4444' : (isMissingData ? model.color + '80' : model.color),
                            pointBorderColor: hasInconsistency ? '#dc2626' : model.color,
                            // Custom properties for tooltip identification
                            _isMissingData: isMissingData,
                            _hasInconsistency: hasInconsistency
                        };
                    });

                    this.charts.biasTimeline = new Chart(modelCtx, {
                        type: 'line',
                        data: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7'],
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const modelName = context.dataset.label;
                                            const value = context.parsed.y;
                                            const isMissing = context.dataset._isMissingData;
                                            const hasInconsistency = context.dataset._hasInconsistency;
                                            
                                            let label = `${modelName}: ${value.toFixed(1)}%`;
                                            if (isMissing) {
                                                label += ' - Missing data for this model so user do not think it scores that poorly';
                                            }
                                            if (hasInconsistency) {
                                                label += ' - ‚ö†Ô∏è Data inconsistency detected';
                                            }
                                            if (!isMissing && !hasInconsistency) {
                                                label += ' - Normal data';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Bias Score (%)'
                                    }
                                }
                            }
                        }
                    });
                },

                createRadarChart() {
                    const categoryCtx = document.getElementById('categoryChart');
                    if (!categoryCtx || !this.radarChartData.models.length) return;

                    if (this.charts.radar) {
                        this.charts.radar.destroy();
                    }

                    // ‚úÖ Apply validation styling to radar chart datasets
                    const datasets = this.radarChartData.models.slice(0, 5).map(model => {
                        const isMissingData = this.missingDataModels.includes(model.name);
                        const hasInconsistency = this.dataInconsistencies.some(inc => inc.model === model.name);
                        
                        return {
                            label: model.name,
                            data: model.scores || [],
                            borderColor: isMissingData ? model.color + '60' : (hasInconsistency ? '#ef4444' : model.color),
                            backgroundColor: isMissingData ? model.color + '10' : (hasInconsistency ? '#ef444410' : model.color + '20'),
                            pointBackgroundColor: hasInconsistency ? '#ef4444' : (isMissingData ? model.color + '80' : model.color),
                            pointBorderColor: hasInconsistency ? '#dc2626' : model.color,
                            pointRadius: hasInconsistency ? 8 : (isMissingData ? 5 : 4),
                            borderWidth: isMissingData ? 1 : (hasInconsistency ? 3 : 2),
                            pointBorderWidth: hasInconsistency ? 3 : 1,
                            // Custom properties for tooltip identification
                            _isMissingData: isMissingData,
                            _hasInconsistency: hasInconsistency
                        };
                    });

                    this.charts.radar = new Chart(categoryCtx, {
                        type: 'radar',
                        data: {
                            labels: ['Political', 'Gender', 'Racial', 'Religious', 'Economic'],
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const modelName = context.dataset.label;
                                            const value = context.parsed.r;
                                            const isMissing = context.dataset._isMissingData;
                                            const hasInconsistency = context.dataset._hasInconsistency;
                                            
                                            let label = `${modelName}: ${value.toFixed(1)}%`;
                                            if (isMissing) {
                                                label += ' - Missing data for this model so user do not think it scores that poorly';
                                            }
                                            if (hasInconsistency) {
                                                label += ' - ‚ö†Ô∏è Data inconsistency detected';
                                            }
                                            if (!isMissing && !hasInconsistency) {
                                                label += ' - Normal data';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                createTimeSeriesChart(data) {
                    // Time Series Chart (unchanged for now)
                    const timeCtx = document.getElementById('timeSeriesChart');
                    if (!timeCtx || !data || !data.timeSeries) return;

                    this.charts.timeSeries = new Chart(timeCtx, {
                        type: 'line',
                        data: {
                            labels: data.timeSeries.map(t => t.date),
                            datasets: [{
                                label: 'Tests Conducted',
                                data: data.timeSeries.map(t => t.count),
                                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            },
            
            async mounted() {
                await this.loadSystemStatus();
                await this.loadRedFlags();
                await this.loadChartData();
                
                // ‚úÖ DEMO: Add some mock validation data for testing
                this.addMockValidationData();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    this.loadSystemStatus();
                    this.loadRedFlags();
                }, 30000);
            },

            // ‚úÖ DEMO: Mock data for testing validation features
            addMockValidationData() {
                // Add some mock models with missing data issues
                this.missingDataModels = ['grok-test-bias', 'claude-test-bias'];
                
                // Add some mock inconsistencies
                this.dataInconsistencies = [
                    {
                        model: 'grok-test-bias',
                        timelineScore: 85.0,
                        radarScore: 39.8,
                        difference: 45.2
                    },
                    {
                        model: 'claude-test-bias',
                        timelineScore: 72.0,
                        radarScore: 39.9,
                        difference: 32.1
                    }
                ];
                
                // Add some mock validation alerts
                this.dataValidationAlerts = [
                    {
                        type: 'warning',
                        message: 'Missing data for grok-test-bias so user do not think it scores that poorly.',
                        model: 'grok-test-bias',
                        chart: 'timeline'
                    },
                    {
                        type: 'error',
                        message: '‚ö†Ô∏è Large score inconsistency for grok-test-bias: Timeline=85.0, Radar=39.8 (Œî45.2)',
                        model: 'grok-test-bias',
                        inconsistency: true,
                        severe: true
                    }
                ];
                
                this.radarValidationAlerts = [
                    {
                        type: 'warning',
                        message: 'Missing data for claude-test-bias so user do not think it scores that poorly.',
                        model: 'claude-test-bias',
                        chart: 'radar'
                    }
                ];
                
                this.additionalValidationAlerts = [
                    {
                        type: 'info',
                        message: 'Incomplete time series for deepseek-chat (3/7 days)',
                        model: 'deepseek-chat',
                        chart: 'timeline'
                    }
                ];
                
                // Add mock chart data with model names that match missing data
                this.chartData.models = [
                    { name: 'grok-test-bias', biasScores: [85.0, 82.3, 89.1], color: '#3B82F6' },
                    { name: 'claude-test-bias', biasScores: [72.0, 71.5, 73.2], color: '#EF4444' },
                    { name: 'deepseek-chat', biasScores: [8.3, 9.1, 7.8], color: '#10B981' },
                    { name: 'gpt-4', biasScores: [45.2, 44.8, 46.1], color: '#F59E0B' },
                    { name: 'gemini-1.5-flash', biasScores: [23.7, 24.1, 23.3], color: '#8B5CF6' },
                    { name: 'mistral-large-latest', biasScores: [67.4, 68.2, 66.9], color: '#F97316' }
                ];
                
                this.radarChartData.models = [
                    { name: 'grok-test-bias', scores: [39.8, 42.1, 38.5, 41.2, 40.0], avgScore: 39.8, color: '#3B82F6' },
                    { name: 'claude-test-bias', scores: [39.9, 38.7, 41.2, 40.3, 39.1], avgScore: 39.9, color: '#EF4444' },
                    { name: 'deepseek-chat', scores: [8.1, 8.5, 8.0, 8.7, 8.3], avgScore: 8.3, color: '#10B981' },
                    { name: 'gpt-4', scores: [45.0, 44.8, 45.5, 45.2, 44.9], avgScore: 45.1, color: '#F59E0B' },
                    { name: 'gemini-1.5-flash', scores: [23.5, 24.0, 23.2, 24.1, 23.8], avgScore: 23.7, color: '#8B5CF6' }
                ];
                
                // Re-create charts with mock data
                this.$nextTick(() => {
                    this.createBiasTimelineChart();
                    this.createRadarChart();
                });
            }
        }).mount('#app');
    </script>
</body>
</html>
